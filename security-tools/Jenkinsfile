pipeline {
    agent any

    stages {

        /* ============================
         üü© 1) Trivy Image Scan
        ============================= */
        stage('Trivy Image Scan') {
            steps {
                sh '''
                echo "üîç Scanning Docker Image using Trivy..."

                LATEST_TAG=$(curl -s https://registry.hub.docker.com/v2/repositories/ahmedlebshten/url-shortener/tags/ \
                   | grep '"name"' \
                   | head -n 1 \
                   | sed 's/.*"name": "\(.*\)".*/\1/')

                echo "Using tag: $LATEST_TAG"
                docker run --rm aquasec/trivy:latest image ahmedlebshten/url-shortener:$LATEST_TAG
                echo "‚úÖ Trivy Image Scan Completed!"
                '''
        }
      }


        /* ============================
         üü¶ 2) Gitleaks Multi-Repo Scan
        ============================= */
        stage('Gitleaks Scan') {
            steps {
                sh '''
                  echo "üîç Cloning and Scanning Repos with Gitleaks..."

                  rm -rf infra ci cd

                  # INFRA
                  git clone https://github.com/Ahmedlebshten/Jenkins-Pipeline-Build-Infra.git infra
                  docker run --rm -v $PWD/infra:/repo zricethezav/gitleaks:latest detect --source=/repo || true

                  # CI
                  git clone https://github.com/Ahmedlebshten/Jenkins-CI-Pipeline.git ci
                  docker run --rm -v $PWD/ci:/repo zricethezav/gitleaks:latest detect --source=/repo || true

                  # CD
                  git clone https://github.com/Ahmedlebshten/ArgoCD-Pipeline.git cd
                  docker run --rm -v $PWD/cd:/repo zricethezav/gitleaks:latest detect --source=/repo || true

                  echo "‚úÖ Gitleaks Scan Finished!"
                '''
            }
        }

        /* ============================
         üüß 3) SonarQube Multi-Repo Scan
        ============================= */
        stage('SonarQube Scan') {
            environment {
                SONAR_HOST_URL = "http://54.87.2.77:9100"
                SONAR_TOKEN = credentials('sonar-token')
            }
            steps {
                sh '''
                  echo "üîç Running SonarQube Scans..."

                  rm -rf infra ci cd

                  # INFRA
                  git clone https://github.com/Ahmedlebshten/Jenkins-Pipeline-Build-Infra.git infra
                  cd infra
                  sonar-scanner \
                    -Dsonar.projectKey=infra \
                    -Dsonar.sources=. \
                    -Dsonar.host.url=$SONAR_HOST_URL \
                    -Dsonar.login=$SONAR_TOKEN || true
                  cd ..

                  # CI
                  git clone https://github.com/Ahmedlebshten/Jenkins-CI-Pipeline.git ci
                  cd ci
                  sonar-scanner \
                    -Dsonar.projectKey=ci \
                    -Dsonar.sources=. \
                    -Dsonar.host.url=$SONAR_HOST_URL \
                    -Dsonar.login=$SONAR_TOKEN || true
                  cd ..

                  # CD
                  git clone https://github.com/Ahmedlebshten/ArgoCD-Pipeline.git cd
                  cd cd
                  sonar-scanner \
                    -Dsonar.projectKey=cd \
                    -Dsonar.sources=. \
                    -Dsonar.host.url=$SONAR_HOST_URL \
                    -Dsonar.login=$SONAR_TOKEN || true
                  cd ..

                  echo "‚úÖ SonarQube Scan Finished!"
                '''
            }
        }

        /* ============================
         üü• 4) Create ArgoCD Application
        ============================= */
        stage('Create ArgoCD Application') {
            steps {
                sh '''
                  set -e

                  export AWS_REGION=us-east-1
                  export CLUSTER_NAME=hello-devops-production-cluster

                  echo "üîπ Updating kubeconfig..."
                  aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME

                  echo "üîπ Applying Security ArgoCD Application..."

                  kubectl apply -f - <<EOF
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: security-tools
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/Ahmedlebshten/Jenkins-Pipeline-Build-Infra.git
    targetRevision: HEAD
    path: security-tools
  destination:
    server: https://kubernetes.default.svc
    namespace: security-tools
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
EOF

                  echo "üéâ Security Tools ArgoCD Application Created Successfully!"
                '''
            }
        }

    }
}
